{"version":3,"file":"offscreen.js","sources":["../../src/offscreen/offscreen.js"],"sourcesContent":["import workerUrl from '../workers/calc.js?worker&url';\r\n\r\n// 1) CrÃ©e le worker et un canal dÃ©diÃ©\r\nconst worker = new Worker(workerUrl, { type: 'module' });\r\nconst channel = new MessageChannel();\r\nconst portToWorker = channel.port1; // ira au worker\r\nconst portLocal   = channel.port2; // gardÃ© cÃ´tÃ© offscreen\r\n\r\n// Transfert du port au worker (zÃ©ro-copie)\r\nworker.postMessage({ type: 'initPort' }, [portToWorker]);\r\n\r\n// 2) Orchestration: reÃ§oit lâ€™ordre du SW (lÃ©ger), rÃ©cupÃ¨re les gros buffers localement\r\nchrome.runtime.onMessage.addListener(async (msg) => {\r\n  if (msg?.target !== 'offscreen') return;\r\n  if (msg.type !== 'job:start') return;\r\n\r\n  const { id, descriptor } = msg;\r\n\r\n  try {\r\n    let buffer; // ArrayBuffer volumineux\r\n\r\n    if (descriptor.source === 'fetch') {\r\n      const resp = await fetch(descriptor.url);\r\n      const ab   = await resp.arrayBuffer();\r\n      buffer = ab; // gros buffer rÃ©cupÃ©rÃ© localement (pas passÃ© via SW)\r\n    } else if (descriptor.source === 'idb') {\r\n      // Exemple: lecture depuis IndexedDB (zÃ©ro message au SW)\r\n      buffer = await readLargeBufferFromIndexedDB(descriptor.key);\r\n    } else if (descriptor.source === 'compose') {\r\n      buffer = descriptor.buffer; // âš ï¸ si tu fournis buffer depuis SW => clonage (Ã©viter)\r\n    }\r\n\r\n    // 3) Envoi au worker avec TRANSFER LIST (zÃ©ro-copie offscreen->worker)\r\n    portLocal.postMessage(\r\n      { id, op: descriptor.op, payload: buffer },\r\n      [buffer] // ðŸ‘ˆ transfert\r\n    );\r\n\r\n    // 4) Attends le rÃ©sultat du worker (petit rÃ©cap ou autre clÃ© IDB)\r\n    const summary = await waitWorkerResult(portLocal, id);\r\n\r\n    // 5) Notifie le SW (lÃ©ger). Optionnel: Ã©cris le gros rÃ©sultat en IDB avant.\r\n    chrome.runtime.sendMessage({ target: 'bg', type: 'job:done', id, summary });\r\n  } catch (err) {\r\n    chrome.runtime.sendMessage({ target: 'bg', type: 'job:error', id, error: String(err?.message || err) });\r\n  }\r\n});\r\n\r\n// Helpers --------------------------\r\n\r\nfunction waitWorkerResult(port, id) {\r\n  return new Promise((resolve, reject) => {\r\n    const onMsg = (evt) => {\r\n      const m = evt.data;\r\n      if (!m || m.id !== id) return;\r\n      if (m.type === 'result') {\r\n        port.removeEventListener('message', onMsg);\r\n        resolve(m.summary);\r\n      } else if (m.type === 'error') {\r\n        port.removeEventListener('message', onMsg);\r\n        reject(new Error(m.error || 'worker error'));\r\n      }\r\n    };\r\n    port.addEventListener('message', onMsg);\r\n    port.start();\r\n  });\r\n}\r\n\r\nasync function readLargeBufferFromIndexedDB(key) {\r\n  // exemple rapide (Ã  adapter Ã  ta DB)\r\n  const db = await openDB('VRDashboardDB', 1);\r\n  return new Promise((resolve, reject) => {\r\n    const tx = db.transaction('largeBlobs', 'readonly');\r\n    const store = tx.objectStore('largeBlobs');\r\n    const req = store.get(key);\r\n    req.onsuccess = () => resolve(req.result?.buffer);\r\n    req.onerror = () => reject(req.error);\r\n  });\r\n}\r\n\r\nfunction openDB(name, version) {\r\n  return new Promise((resolve, reject) => {\r\n    const req = indexedDB.open(name, version);\r\n    req.onsuccess = () => resolve(req.result);\r\n    req.onerror = () => reject(req.error);\r\n  });\r\n}\r\n"],"names":[],"mappings":";;AAGA,MAAM,SAAS,IAAI,OAAO,WAAW,EAAE,MAAM,SAAQ,CAAE;AACvD,MAAM,UAAU,IAAI;AACpB,MAAM,eAAe,QAAQ;AAC7B,MAAM,YAAc,QAAQ;AAG5B,OAAO,YAAY,EAAE,MAAM,WAAU,GAAI,CAAC,YAAY,CAAC;AAGvD,OAAO,QAAQ,UAAU,YAAY,OAAO,QAAQ;AAClD,OAAI,2BAAK,YAAW;AAAa;AACjC,MAAI,IAAI,SAAS;AAAa;AAE9B,QAAM,EAAE,IAAI,WAAY,IAAG;AAE3B,MAAI;AACF,QAAI;AAEJ,QAAI,WAAW,WAAW,SAAS;AACjC,YAAM,OAAO,MAAM,MAAM,WAAW,GAAG;AACvC,YAAM,KAAO,MAAM,KAAK;AACxB,eAAS;AAAA,IACf,WAAe,WAAW,WAAW,OAAO;AAEtC,eAAS,MAAM,6BAA6B,WAAW,GAAG;AAAA,IAChE,WAAe,WAAW,WAAW,WAAW;AAC1C,eAAS,WAAW;AAAA,IACrB;AAGD,cAAU;AAAA,MACR,EAAE,IAAI,IAAI,WAAW,IAAI,SAAS,OAAQ;AAAA,MAC1C,CAAC,MAAM;AAAA;AAAA,IACb;AAGI,UAAM,UAAU,MAAM,iBAAiB,WAAW,EAAE;AAGpD,WAAO,QAAQ,YAAY,EAAE,QAAQ,MAAM,MAAM,YAAY,IAAI,QAAO,CAAE;AAAA,EAC3E,SAAQ,KAAK;AACZ,WAAO,QAAQ,YAAY,EAAE,QAAQ,MAAM,MAAM,aAAa,IAAI,OAAO,QAAO,2BAAK,YAAW,GAAG,EAAC,CAAE;AAAA,EACvG;AACH,CAAC;AAID,SAAS,iBAAiB,MAAM,IAAI;AAClC,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAM,QAAQ,CAAC,QAAQ;AACrB,YAAM,IAAI,IAAI;AACd,UAAI,CAAC,KAAK,EAAE,OAAO;AAAI;AACvB,UAAI,EAAE,SAAS,UAAU;AACvB,aAAK,oBAAoB,WAAW,KAAK;AACzC,gBAAQ,EAAE,OAAO;AAAA,MACzB,WAAiB,EAAE,SAAS,SAAS;AAC7B,aAAK,oBAAoB,WAAW,KAAK;AACzC,eAAO,IAAI,MAAM,EAAE,SAAS,cAAc,CAAC;AAAA,MAC5C;AAAA,IACP;AACI,SAAK,iBAAiB,WAAW,KAAK;AACtC,SAAK,MAAK;AAAA,EACd,CAAG;AACH;AAEA,eAAe,6BAA6B,KAAK;AAE/C,QAAM,KAAK,MAAM,OAAO,iBAAiB,CAAC;AAC1C,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAM,KAAK,GAAG,YAAY,cAAc,UAAU;AAClD,UAAM,QAAQ,GAAG,YAAY,YAAY;AACzC,UAAM,MAAM,MAAM,IAAI,GAAG;AACzB,QAAI,YAAY,MAAM;;AAAA,sBAAQ,SAAI,WAAJ,mBAAY,MAAM;AAAA;AAChD,QAAI,UAAU,MAAM,OAAO,IAAI,KAAK;AAAA,EACxC,CAAG;AACH;AAEA,SAAS,OAAO,MAAM,SAAS;AAC7B,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAM,MAAM,UAAU,KAAK,MAAM,OAAO;AACxC,QAAI,YAAY,MAAM,QAAQ,IAAI,MAAM;AACxC,QAAI,UAAU,MAAM,OAAO,IAAI,KAAK;AAAA,EACxC,CAAG;AACH;"}